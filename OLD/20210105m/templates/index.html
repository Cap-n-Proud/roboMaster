<!DOCTYPE html>
<html>

  <head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/clocklet@0.3.0/css/clocklet.min.css">
    <script src="https://cdn.jsdelivr.net/npm/clocklet@0.3.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js" integrity="sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ==" crossorigin="anonymous"></script>

    <script>
      /* `window.clocklet` object is available */
    </script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Changa|Frank+Ruhl+Libre:500">


    <style>
      .clocklet-options-1 {
        font-family: Changa, sans-serif;
        border-radius: 50%;
      }
    </style>

    <style>
      .clocklet-options-2 {
        font-family: "Frank Ruhl Libre", serif;
        font-weight: 500;
      }
    </style>
  </head>

  <body>
    <table>
      <tr>
        <td>
          <button class="button button3" onclick="changeProgram()">change program</button>
        </td>
        <button class="button button3" onclick="sendProgram()">send program</button></td>
        <td>
          <label for="prg">Choose a program:</label>
          <select id="PRGsel" onchange="loadProgram(this.value)">
            <option value="">-- Select --</option>
          </select>
        </td>
        <td><span id="progLabel"></span></td>
      </tr>
      <tr>
        <td><button onclick="topFunction()" id="myBtn" title="Go to top">Top</button></td>
        <td></td>
        <td></td>
      </tr>
      <tr>
        <td>
          <label for="LEDBrightness">Color:</label>
        </td>
        <td> <input type="range" min="0" max="100" value="50" id="LEDBrightness" onchange="setBrightness()">
          <label for="LEDColor"></label>
          <input type="color" id="LEDColor" name="LEDColor" onchange="setColor()">
          <input data-clocklet="class-name: clocklet-options-2; format: HH:mm; alignment: right; append-to: parent;" placeholder="" size="3" id="LightsONTime">
          <input data-clocklet="class-name: clocklet-options-2; format: HH:mm; alignment: right; append-to: parent;" placeholder="" size="3" id="LightsOFFTime">
        </td>
        <td><span id="brightnessLabel"></span><span id="colorLabel"></td>
      </tr>
      <tr>
        <td>Pump</td>
        <td>
          <label class="switch">
            <input id="pump" type="checkbox" value="OFF" onchange="getPump(this)">
            <span class="slider round"></span><input data-clocklet>
          </label>
          <label for="pumpPulse">duration</label>
          <input type="number" id="pumpPulse" name="quantity" min="1" max="20" size="2">



        </td>
        <td><span id="pumpLabel"></span></td>
      </tr>
      <tr>
        <td colspan="3" id="infoBox">&nbsp;</td>
      </tr>
    </table>
    <br>
    <table id="currentProgramLabel">
      <tr>
        <td></td>
        <td></td>
        <td></td>
      </tr>
      <tr>
        <td></td>
        <td></td>
        <td></td>
      </tr>

    </table>

    <div id="myData"></div>
    <script>
      //Calls functions to load defaults and info.
      document.addEventListener("DOMContentLoaded", function() {
        getCurrentProgram();
        loadSelect();
      });

      //Get the button
      var mybutton = document.getElementById("myBtn");
      mybutton.style.display = "block";

      // When the user scrolls down 20px from the top of the document, show the button
      window.onscroll = function() {
        scrollFunction()
      };

      function scrollFunction() {
        if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
          mybutton.style.display = "block";
        } else {
          mybutton.style.display = "none";
        }
      }

      // When the user clicks on the button, scroll to the top of the document
      function topFunction() {
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
      }

      var slider = document.getElementById("LEDBrightness");
      var output = document.getElementById("brightnessLabel");
      output.innerHTML = slider.value;

      slider.oninput = function() {
        output.innerHTML = this.value;
      }

      function postCommand(cmd) {
        const URL = `${window.origin}/arduinoCommand`
        // post body data
        const command = {
          command: cmd
        };

        // request options
        const options = {
          method: 'POST',
          body: JSON.stringify(command),
          headers: {
            'Content-Type': 'application/json'
          }
        }

        // send POST request
        fetch(URL, options)
          .then(res => res.json())
        //.then(res => console.log(res));
      }
      //Change pump status based on the checkbox TODO based on the arduino feedback
      function getPump(checkboxElem) {
        var x = document.getElementById("pump");
        if (checkboxElem.checked) {
          document.getElementById("pumpLabel").innerHTML = "ON";
          var timer = document.getElementById("pumpPulse").value;

          var cmd = "pumpStart" + " " + timer
          postCommand(cmd)
        } else {
          document.getElementById("pumpLabel").innerHTML = "OFF";
          var cmd = "pumpStop"
          postCommand(cmd)

        }
      }

      function setColor() {
        var x = document.getElementById("LEDColor").value;
        document.getElementById("colorLabel").innerHTML = hexTorgb(x);

        var cmd = "setLightRGB" + " " + hexTorgb(x);
        postCommand(cmd)
      }

      function setBrightness() {
        var x = document.getElementById("LEDBrightness").value;

        var cmd = "setBrightness" + " " + x;
        postCommand(cmd)
      }
      // Use this to program the server and arduino to change program
      function changeProgram() {
        var URL1 = 'http://127.0.0.1:5000/programs'
        var req = new XMLHttpRequest();
        var ID = document.getElementById("PRGsel").value
        req.open('GET', URL1, false);
        req.send(null);
        let data = JSON.parse(req.responseText);
        console.log(data[ID]);
        var URL2 = 'http://127.0.0.1:5000/serverCommand'

        // Send a post request
        fetch(URL2, {
          method: "POST",
          body: JSON.stringify(data[ID]),
          headers: {
            "Content-type": "application/json; charset=UTF-8"
          }
        })

      }
      //
      // function postProgram(){
      //  document.getElementById("progLabel").innerHTML = ""
      //  var req = new XMLHttpRequest();
      //  var ID = document.getElementById("PRGsel").value
      //  req.open('GET', 'http://127.0.0.1:5000/programs', false);
      //  req.send(null);
      //  console.log(typeof req.responseText);
      //  let jsonObject = JSON.parse(req.responseText);
      //  console.log(jsonObject[ID]);

      //console.log(req.responseText.json())
      // var rgb = (data[ID]['RGB'].split(/[ ,]+/).join(','))

      //  }

      //This is used to visualize The program selected from teh select
      function loadProgram(ID) {
        document.getElementById("progLabel").innerHTML = ""

        fetch('http://127.0.0.1:5000/programs')
          .then(function(response) {
            return response.json();
          })
          .then(function(data) {
            var PrgContainer = document.getElementById("progLabel");
            for (name in data[ID]) {
              var div = document.createElement("div");
              div.innerHTML = name + ' ' + data[ID][name];
              PrgContainer.appendChild(div);

            }
            // document.getElementById("LEDBrightness").value = data['lightBrightness']
            document.getElementById("LEDBrightness").value = data[ID]['lightBrightness']
            var rgb = data[ID]['RGB'].split(" ");
            //document.getElementById("LEDColor").value = rgbToHex(rgb[0],rgb[1],rgb[2])
            //hexColor = rgbToHex(rgb[0],rgb[1],rgb[2])
            hexColor = R_G_BtoHEX(rgb[0], rgb[1], rgb[2])
            document.getElementById("LEDColor").value = hexColor
            document.getElementById("brightnessLabel").innerHTML = data[ID]['lightBrightness']
          })
          .catch(function(err) {
            console.log('error: ' + err);
          });


      }

      function loadSelect() {
        fetch('http://127.0.0.1:5000/programs')
          .then(function(response) {
            return response.json();
          })
          .then(function(data) {
            var ele = document.getElementById('PRGsel');
            for (var i = 0; i < data.length; i++) {
              // POPULATE SELECT ELEMENT WITH JSON.
              ele.innerHTML = ele.innerHTML +
                '<option value="' + i + '">' + data[i]['progName'] + '</option>';
            }

          })


      }

      function getCurrentProgram() {
        fetch('http://127.0.0.1:5000/currentProgram')
          .then(function(response) {
            return response.json();
          })
          .then(function(data) {
            const keys = Object.keys(data);
            var ele = document.getElementById('currentProgramLabel');
            keys.forEach((key, index) => {
              // console.log(`${key}: ${data[key]}`);
              ele.innerHTML = ele.innerHTML +
                '<tr><td>' + key + '</td><td>' + data[key] + '</td><td></td></tr>';
            });
            for (var i = 0; i < data; i++) {
              // POPULATE SELECT ELEMENT WITH JSON.
              ele.innerHTML = ele.innerHTML +
                '<tr><td>' + data[i] + '</td></tr>';
            }
          })
      }

      function hexTorgb(hex) {
        return ['0x' + hex[1] + hex[2] | 0, '0x' + hex[3] + hex[4] | 0, '0x' + hex[5] + hex[6] | 0];
      }

      function R_G_BtoHEX(red, green, blue) {
        red = red < 0 ? 0 : red > 255 ? 255 : red;
        green = green < 0 ? 0 : green > 255 ? 255 : green;
        blue = blue < 0 ? 0 : blue > 255 ? 255 : blue;

        return "#" +
          ("0" + parseInt(red, 10).toString(16)).slice(-2) +
          ("0" + parseInt(green, 10).toString(16)).slice(-2) +
          ("0" + parseInt(blue, 10).toString(16)).slice(-2);
      }
      var socket = io();

      function sendProgram() {

        socket.emit('sendProgram');



      }
      $(document).ready(function() {
        // Connect to the Socket.IO server.
        // The connection URL has the following format, relative to the current page:
        //     http[s]://<domain>:<port>[/<namespace>]

        // Event handler for new connections.
        // The callback function is invoked when a connection with the
        // server is established.
        socket.on('connect', function() {
          socket.emit('my_event', {
            data: 'I\'m connected!'
          });
          console.log("connected!")
        });

        // Event handler for server sent data.
        // The callback function is invoked whenever the server emits data
        // to the client. The data is then displayed in the "Received"
        // section of the page.
        socket.on('my_response', function(msg, cb) {
          $('#log').append('<br>' + $('<div/>').text('Received #' + msg.count + ': ' + msg.data).html());
          console.log("received")
          if (cb)
            cb();
        });
        socket.on('info', function(msg, cb) {
          document.getElementById("infoBox").innerHTML = msg.replace("I,", "")
          if (cb)
            cb();
        });


        var start_time;
        window.setInterval(function() {
          start_time = (new Date).getTime();
          socket.emit('my_ping');
        }, 1000);

        $('form#disconnect').submit(function(event) {
          socket.emit('disconnect_request');
          return false;
        });
      });
    </script>
  </body>

</html>