<!DOCTYPE html>
<html>

  <head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/clocklet@0.3.0/css/clocklet.min.css">
    <script src="https://cdn.jsdelivr.net/npm/clocklet@0.3.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js" integrity="sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ==" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="path/to/font-awesome/css/font-awesome.min.css">

    <script>
      /* `window.clocklet` object is available */
    </script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Changa|Frank+Ruhl+Libre:500">


    <style>
      .clocklet-options-1 {
        font-family: Changa, sans-serif;
        border-radius: 50%;
      }
    </style>

    <style>
      .clocklet-options-2 {
        font-family: "Frank Ruhl Libre", serif;
        font-weight: 500;
      }
    </style>
  </head>
  <!-- https://www.w3schools.com/howto/tryit.asp?filename=tryhow_css_display_element_hover -->

  <body>
    <table>
      <tr>
        <td>
          <i id="LED" class="material-icons" style="background: rgba(0,0 0,0)">lightbulb-outline</i>
        </td>
        <td></td>
        <td><i id="pump" class="material-icons">swap_vert</i></td>
      </tr>
      <tr>
        <td id="LED-text"></td>
        <td></td>
        <td id="pump-text"></td>
      </tr>
      <tr>
        <td id="infoBox" colspan="3"></td>

      </tr>
    </table><br>
    <!-- <i id="LED" class="material-icons">lightbulb-outline</i> -->
    <!-- lightbulb-outline
    lightbulb-on-outline
  https://material.io/resources/icons/?style=round-->
    <script>
      //Calls functions to load defaults and info.
      document.addEventListener("DOMContentLoaded", function() {

        // createCheckBoxes();
        getStatus();
      });

      // When the user scrolls down 20px from the top of the document, show the button
      window.onscroll = function() {
        scrollFunction()
      };

      // When the user clicks on the button, scroll to the top of the document
      function topFunction() {
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
      }


      function postCommand(cmd) {
        const URL = `${window.origin}/arduinoCommand`
        // post body data
        const command = {
          command: cmd
        };

        // request options
        const options = {
          method: 'POST',
          body: JSON.stringify(command),
          headers: {
            'Content-Type': 'application/json'
          }
        }

        // send POST request
        fetch(URL, options)
          .then(res => res.json())
        //.then(res => console.log(res));
      }

      function getCurrentProgram() {
        fetch('http://127.0.0.1:5000/currentProgram')
          .then(function(response) {
            return response.json();
          })
          .then(function(data) {
            const keys = Object.keys(data);
            var ele = document.getElementById('currentProgramLabel');
            keys.forEach((key, index) => {
              // console.log(`${key}: ${data[key]}`);
              ele.innerHTML = ele.innerHTML +
                '<tr><td>' + key + '</td><td>' + data[key] + '</td><td></td></tr>';
            });
            for (var i = 0; i < data; i++) {
              // POPULATE SELECT ELEMENT WITH JSON.
              ele.innerHTML = ele.innerHTML +
                '<tr><td>' + data[i] + '</td></tr>';
            }
          })
      }

      function hexTorgb(hex) {
        return ['0x' + hex[1] + hex[2] | 0, '0x' + hex[3] + hex[4] | 0, '0x' + hex[5] + hex[6] | 0];
      }

      function R_G_BtoHEX(red, green, blue) {
        red = red < 0 ? 0 : red > 255 ? 255 : red;
        green = green < 0 ? 0 : green > 255 ? 255 : green;
        blue = blue < 0 ? 0 : blue > 255 ? 255 : blue;

        return "#" +
          ("0" + parseInt(red, 10).toString(16)).slice(-2) +
          ("0" + parseInt(green, 10).toString(16)).slice(-2) +
          ("0" + parseInt(blue, 10).toString(16)).slice(-2);
      }

      function createCheckBox(table, ID, plantID, plantName) {
        var hold = document.getElementById(table);
        var checkbox = document.createElement('input');
        checkbox.type = "checkbox";
        checkbox.name = ID;
        checkbox.id = ID;
        var label = document.createElement('label');
        var tn = document.createTextNode(plantName);
        label.htmlFor = ID;
        label.appendChild(tn);
        hold.appendChild(label);
        hold.appendChild(checkbox);
      }

      function createCheckBoxes() {

        var ele = document.getElementById('trees');
        var ID = "1"
        var plantID = "12"
        var plantName = "Straberry"
        for (var i = 0; i < 10; i++) {
          // POPULATE SELECT ELEMENT WITH JSON.
          ele.innerHTML = ele.innerHTML +
            // '<tr><td> ' + createCheckBox(table, i, "32", "Straberry") + ' </td><td> ' + createCheckBox(table, i, "32", "Straberry") + ' </td><td> ' + createCheckBox(table, i, "32", "Straberry") + ' </td></tr>'
            '<tr><td> ' + '<input type = "checkbox" id = "' + ID + '" value = "' + plantID + '" />' + '<label for = "' + ID + '">' + plantName + '</label>' + ' </td><td> ' + '<input type = "checkbox" id = "' + ID + '" value = "' + plantID + '" />' +
            '<label for = "' + ID + '">' + plantName + '</label>' + ' </td><td> ' + '<input type = "checkbox" id = "' + ID + '" value = "' + plantID + '" />' + '<label for = "' + ID + '">' + plantName + '</label>' + ' </td></tr>'


          ;
        }

      }


      // https://stackoverflow.com/questions/19032954/why-is-jsonobject-length-undefined
      // console.log(data.lenght)
      // console.log(Object.keys(data.towers).length)
      // //
      // console.log(data.towers)
      // console.log(data.towers[1].name)
      // console.log(data.towers[1].levels[2].pods)
      // console.log(data.lenght)
      // console.log(data.towers[0].tower01[1].pods[0].plantName)
      // console.log(data.towers[0].level)
      function getStatus() {
        fetch('http://127.0.0.1:5000/api/s')
          .then(function(response) {
            return response.json();
          })
          .then(function(data) {
            var ele = document.getElementById('T');

            // Access the towers
            for (var t = 0; t < (data.towers).length; t++) {
              var x = document.createElement("TABLE");
              var towerName = data.towers[t].name;
              x.setAttribute("id", towerName);
              document.body.appendChild(x);
              // Access the levels
              var towerHeight = data.towers[t].levels.length;
              for (var l = towerHeight - 1; l >= 0; l--) {
                var table = document.getElementById(towerName);
                var row = table.insertRow();
                var zerofilledLevel = ('00' + data.towers[t].levels[l].level).slice(-2);
                row.setAttribute("id", "level-" + '0' + (t + 1) + '-' + zerofilledLevel)
                // Acces the pods
                var numberOfPods = data.towers[t].levels[l].pods.length;
                for (var p = 0; p < numberOfPods; p++) {
                  var cell = row.insertCell(p);
                  let date = new Date(data.towers[t].levels[l].pods[p].plantedDate);
                  cell.setAttribute("id", data.towers[t].levels[l].pods[p].podID)
                  cell.innerHTML = '<span style = "color:grey;font-size:12px;"> ' + data.towers[t].levels[l].pods[p].podID + ' </span><br>' + data.towers[t].levels[l].pods[p].plantName;
                  cell.innerHTML = cell.innerHTML + '<br><span style="color:grey;font-size:12px;">' + date.getDate() + "-" + date.getMonth() + 1 + "-" + date.getFullYear() + '</span>';
                }
              }
            }
          })
      }

      var socket = io();

      $(document).ready(function() {
        // Connect to the Socket.IO server.
        // The connection URL has the following format, relative to the current page:
        //     http[s]://<domain>:<port>[/<namespace>]

        // Event handler for new connections.
        // The callback function is invoked when a connection with the
        // server is established.
        socket.on('connect', function() {
          socket.emit('statusConnected', {
            data: 'I\'m connected!'
          });
          console.log("connected!")
        });

        // Event handler for server sent data.
        // The callback function is invoked whenever the server emits data
        // to the client. The data is then displayed in the "Received"
        // section of the page.
        socket.on('telemetry', function(msg, cb) {
          // https://stackoverflow.com/questions/9053016/replace-spaces-with-commas-with-javascript
          var cmd = ""
          document.getElementById("pump-text").innerHTML = msg['pumpON']

          if (msg['Brightness'] == 0) {
            cmd = "background: rgba(190, 190, 190, 1)"
            document.getElementById("LED").innerHTML = "lightbulb-outline"
          } else {
            cmd = "background: rgba(" + msg['RGB'].split(/[ ,]+/).join(',') + "," + msg['brightness'] / 10 + ")"
            document.getElementById("LED").innerHTML = "lightbulb-on-outline"
          }
          document.getElementById("LED").setAttribute("style", cmd)

          if (msg['pumpON'] == 0) {
            cmd = "background: rgba(190, 190, 190, 0.5)"
            document.getElementById("pump").setAttribute("style", cmd)
          } else {
            cmd = "background: rgba(0, 0, 0, 0)"
            document.getElementById("pump").setAttribute("style", cmd)
          }
          document.getElementById("LED-text").innerHTML = msg['RGB'] + ' ' + msg['brightness']

          //background: rgba(255, 175, 80, 0.8)
          //console.log(new Uint8Array(msg))
          if (cb)
            cb();
        });
        socket.on('info', function(msg, cb) {
          document.getElementById("infoBox").innerHTML = msg.replace("I,", "")
          if (cb)
            cb();
        });


        var start_time;
        window.setInterval(function() {
          start_time = (new Date).getTime();
          socket.emit('my_ping');
        }, 1000);

        $('form#disconnect').submit(function(event) {
          socket.emit('disconnect_request');
          return false;
        });
      });
    </script>
  </body>

</html>